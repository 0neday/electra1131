//
//  rootfs_remount_offsetfinder.cpp
//  multi_path
//
//  Created by CoolStar on 6/7/18.
//  Copyright Â© 2018 Ian Beer. All rights reserved.
//

#include <stdint.h>
#include <stdio.h>
#include "rootfs_remount.h"
#include "liboffsetfinder64.hpp"

using namespace std;
using namespace tihmstar;

extern "C" uint64_t offset_vnode_getfromfd;
extern "C" uint64_t offset_vfs_context_current;

extern "C" bool getOffsets(){
    printf("Initializing offsetfinder...\n");
    offsetfinder64 fi("/System/Library/Caches/com.apple.kernelcaches/kernelcache");
    printf("Initialized offsetfinder\n");
    
    try {
        offset_vnode_getfromfd = (uint64_t)fi.find_sym("_vnode_getfromfd");
        offset_vfs_context_current = (uint64_t)fi.find_sym("_vfs_context_current");
        
        printf("vnode_getfromfd: %p\n", (void *)offset_vnode_getfromfd);
        printf("vfs_context_current: %p\n", (void *)offset_vfs_context_current);
        return true;
    } catch (tihmstar::exception &e){
        printf("offsetfinder failure! %d (%s)\n", e.code(), e.what());
        return false;
    } catch (std::exception &e){
        printf("fatal offsetfinder failure! %s\n", e.what());
        return false;
    }
}
